name: Backend CI

on:
  push:
    branches: [ fix/cd-plain-jar-issue ]
  pull_request:
    branches: [ develop, main ]
    types: [ opened, synchronize, reopened ]

permissions:
  id-token: write      # required to get OIDC token
  contents: read       # required to check out repository content

jobs:
  # ----------------------------
  # 1. Build (í…ŒìŠ¤íŠ¸ ì œì™¸)
  # ----------------------------
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Setup java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: gradle

      - name: Build (no test)
        run: ./gradlew build -x test

      - name: Upload jar (temporary for downstream job)
        uses: actions/upload-artifact@v4
        with:
          name: be-jar
          path: build/libs/*.jar
          retention-days: 1

  # ----------------------------
  # 2. Test
  # ----------------------------
  test:
    name: Test (unit/integration)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Setup java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: gradle

      - name: test (develop)
        if: ${{ github.base_ref == 'develop' }}
        env:
          SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE_TEST }}
        run: ./gradlew test 

      - name: Integration test + JaCoCo (main)
        if: ${{ github.base_ref == 'main' }}
        env:
          COVERAGE_MIN: ${{ vars.COVERAGE_MIN }}
          SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE_TEST }}
        run: ./gradlew integrationTest jacocoTestReport jacocoTestCoverageVerification -PCOVERAGE_MIN=${{ env.COVERAGE_MIN }}

  # ----------------------------
  # 3. Static Analysis
  # ----------------------------
  static_analysis:
    name: Static Analysis (Sonar Cloud)
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.base_ref == 'develop' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: gradle
      
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Sonar Cloud scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew build -x test sonar --info

  # ----------------------------
  # 4. Artifacts (develop)
  # ----------------------------
  artifacts:
    name: Upload Verified Artifact (develop)
    runs-on: ubuntu-latest
    needs: [build, test, static_analysis]
    if: ${{ github.base_ref == 'develop' }}

    steps:
      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: be-jar
          path: artifact

      - name: Upload jar
        uses: actions/upload-artifact@v4
        with:
          name: verified-be-jar
          path: artifact/*.jar
          retention-days: 90

  # ----------------------------
  # 5. Main â†’ S3 Archive
  # ----------------------------
  main_archive:
    name: Archive release to S3
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.base_ref == 'main' || github.ref_name == 'fix/cd-plain-jar-issue' }}

    steps:
      - name: Set meta
        id: meta
        run: |
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: be-jar
          path: artifact

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: List artifact
        run: ls -la artifact && find artifact -maxdepth 2 -type f

      - name: Upload jar to S3
        env:
          BUCKET: ${{ secrets.RELEASE_BUCKET }}
          PREFIX: releases/backend
        run: |
          aws s3 cp artifact/ \
            s3://$BUCKET/$PREFIX/${{ steps.meta.outputs.timestamp }} \
            --recursive \
            --exclude "*" \
            --include "*.jar"

  # ----------------------------
  # 6. Deploy (fix/cd-plain-jar-issue í…ŒìŠ¤íŠ¸ìš©)
  # ----------------------------
  deploy_test:
    name: Deploy (test branch)
    runs-on: ubuntu-latest
    needs: main_archive
    if: ${{ github.ref_name == 'fix/cd-plain-jar-issue' }}

    steps:
      - name: Get timestamp (UTC)
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Deploy from S3 and Execute
        uses: appleboy/ssh-action@master
        env:
          RELEASE_BUCKET: ${{ secrets.RELEASE_BUCKET }}
          TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SCHEMA: ${{ secrets.DB_SCHEMA }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          envs: RELEASE_BUCKET,TIMESTAMP,DB_PORT,DB_SCHEMA,DB_USER,DB_PASSWORD
          script: |
            cd /home/ubuntu/backend

            # S3ì—ì„œ ìµœì‹  ë²„ì „ ì°¾ê¸°
            LATEST_VERSION=$(aws s3 ls s3://$RELEASE_BUCKET/releases/backend/ | sort | tail -1 | awk '{print $2}' | tr -d '/')
            echo "ìµœì‹  ë²„ì „: $LATEST_VERSION"

            # S3ì—ì„œ jar ë‹¤ìš´ë¡œë“œ (plain.jar ì œì™¸)
            NEW_JAR="app-$TIMESTAMP.jar"
            aws s3 cp s3://$RELEASE_BUCKET/releases/backend/$LATEST_VERSION/ ./ --recursive --exclude "*" --include "*.jar" --exclude "*-plain.jar"

            # ë‹¤ìš´ë¡œë“œí•œ jar íŒŒì¼ ì´ë¦„ ë³€ê²½ (plain ì œì™¸)
            DOWNLOADED_JAR=$(ls -t *.jar 2>/dev/null | grep -v "^app-" | grep -v "plain" | head -n 1)
            if [ -n "$DOWNLOADED_JAR" ]; then
              mv "$DOWNLOADED_JAR" "$NEW_JAR"
              echo "Renamed $DOWNLOADED_JAR to $NEW_JAR"
            fi

            # ì´ì „ ë²„ì „ ë°±ì—… (ë¡¤ë°±ìš©) - ìƒˆ jar ì œì™¸
            PREVIOUS_JAR=$(ls -t app-*.jar 2>/dev/null | grep -v "^$NEW_JAR$" | head -n 1)
            echo "PREVIOUS_JAR=$PREVIOUS_JAR" > .deploy_info

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID íŒŒì¼ ì‚¬ìš©)
            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: PID $OLD_PID"
                sleep 3
              fi
              rm -f backend.pid
            fi

            # ìƒˆ ë²„ì „ ì‹¤í–‰
            DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USER=$DB_USER DB_PASSWORD=$DB_PASSWORD \
              nohup java -jar "$NEW_JAR" > backend.log 2>&1 &
            echo $! > backend.pid
            echo "ìƒˆ ë²„ì „ ì‹¤í–‰: $NEW_JAR (PID: $(cat backend.pid))"

      - name: Health Check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Health Check ì‹œì‘ (30ì´ˆ ëŒ€ê¸°)..."
            sleep 30

            # 3íšŒ ì¬ì‹œë„ (10ì´ˆ ê°„ê²©)
            for i in 1 2 3; do
              echo "Health Check ì‹œë„ $i/3"
              if curl -sf http://localhost:8080/api/health > /dev/null; then
                echo "Health Check ì„±ê³µ"
                exit 0
              fi
              sleep 10
            done

            echo "Health Check ì‹¤íŒ¨"
            exit 1

      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        env:
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SCHEMA: ${{ secrets.DB_SCHEMA }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          envs: DB_PORT,DB_SCHEMA,DB_USER,DB_PASSWORD
          script: |
            cd /home/ubuntu/backend

            # í˜„ì¬ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID íŒŒì¼ ì‚¬ìš©)
            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                sleep 3
              fi
              rm -f backend.pid
            fi

            # ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
            source .deploy_info
            if [ -n "$PREVIOUS_JAR" ] && [ -f "$PREVIOUS_JAR" ]; then
              DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USER=$DB_USER DB_PASSWORD=$DB_PASSWORD \
                nohup java -jar "$PREVIOUS_JAR" > backend.log 2>&1 &
              echo $! > backend.pid
              echo "ë¡¤ë°± ì™„ë£Œ: $PREVIOUS_JAR (PID: $(cat backend.pid))"
            else
              echo "ë¡¤ë°± ì‹¤íŒ¨: ì´ì „ ë²„ì „ ì—†ìŒ"
              exit 1
            fi

      - name: Notify Discord - Success
        if: steps.health_check.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ (í…ŒìŠ¤íŠ¸)"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar"

      - name: Notify Discord - Failure
        if: steps.health_check.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨ (í…ŒìŠ¤íŠ¸)"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar ë°°í¬ ì‹¤íŒ¨"

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1